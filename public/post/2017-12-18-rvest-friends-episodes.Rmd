---
title: "rvest + imdb -> explore Friends episode titles"
author: "Jesse Tweedle"
date: 2017-12-18T15:33:11-05:00
description: "This post includes R code to download Friends episode data from IMDB using the package rvest. It analyzes and visualizes episode data."
tags: ["r", "friends", "imdb", "tidytext", "rvest"]
categories: ["r"]
---

```{r setup, include=FALSE}
# set fig_height, fig_width.
knitr::opts_chunk$set(collapse = TRUE, fig.width=7, fig.height=4)
library(tidyverse)
library(rvest)
library(skimr)
library(ggplot2)
library(ggrepel)
library(tidytext)
```

I always wanted to be a scriptwriter. But my approach to doing creative things is "find the secret, program it, retire". So what's the secret to a successful Friends episode? [Really, I want to write/experience a gentle introduction to `rvest`, and later `tidytext` and language data science.]

## Get data

I'll get data on Friends episodes from IMDB via `rvest` (see here for [tutorials](https://github.com/hadley/rvest) and [documentation](https://cran.r-project.org/web/packages/rvest/rvest.pdf)).

Start your engines:
``` {r eval = FALSE}
library(tidyverse)
library(rvest)
library(skimr)
library(ggplot2)
library(ggrepel)
library(tidytext)
```

First, find the link, and download some html. This takes some back and forth---I'll do that annoying thing where I present the finished product as if I thought of it straight away. Suppose we have two functions: 

``` {r eval = FALSE}
get_ep_data <- function(ep_url, url) {
  # get season no., episode no., episode title, episode rating, no. of ratings
  # director, and writers
  # return the tibble of episode data
}

get_season_data <- function(url) {
  # ...
  # return a tibble of data from all the episodes in a given season
}
```

Given those functions (we'll talk about them later), we only need to go through the list of episodes and download everything.

``` {r eval = FALSE}
# the base Friends url; it only needs a season number suffix
url <- "http://www.imdb.com/title/tt0108778/episodes?season="

# make a list of all the season urls (there are 10 seasons)
season_urls <- map_chr(1:10, function(n) {paste0(url, n)})

# for each season in the list, download all the data and put it together 
titles <- season_urls %>% map(get_season_data) %>% bind_rows()
```

``` {r eval = TRUE, include = FALSE}
# devtools::install_github('tweed1e/werfriends')
# library(werfriends)
# library(werfriends)
titles <- werfriends::friends_episodes %>% tbl_df()
# but for now, skip it so I don't re-download it every time.
# print(getwd())
# save(titles, list = c("titles"), file = "analysis_drafts/friends_episodes.RData")
# titles <- readRDS('/Users/jessetweedle/Documents/github/weblog/analysis_drafts/friends_episodes.rds') %>% tbl_df()
# titles <- load('analysis_drafts/friends_episodes.rdata') %>% tbl_df()
```

## Inspect the data

The data includes season, episode, title, rating, number of ratings, director and writers (in list form, because there's usually more than one writer, and sometimes multiple directors).

``` {r }
titles
```

The rating distribution is skewed pretty high---the mean rating is `r mean(titles$rating) %>% round(2)`, with a maximum of `r max(titles$rating)` and minimum of `r min(titles$rating)`.

### Ratings by season

Did Friends get better over time?

``` {r}
ggplot(titles, aes(x = factor(season), y = rating, group = season)) +
  geom_boxplot() + ylim(NA, 10) +
  labs(title = "Friends Ratings By Season", x = "Season #", y = "Rating")
```

Well, a bit---it peaks in Season 5 (`r emo::ji('white_check_mark')`), drops a bit in 9 (`r emo::ji('white_check_mark')`) and comes back for the final season. That checks out. It started good, hit its stride in the middle, started to lose steam around 8 and 9 (see the list of worst episodes `r emo::ji('arrow_down')`). 

So what are the best and worst episodes?

``` {r}
# The best episodes
titles %>% arrange(-rating) %>% head(5)
```

'Embryos' is the ep where the winner of a quiz wins Monica and Rachel's apartment. So good. 'Everybody Finds Out': it's the one where Phoebe finds out about Monica/Chandler's relationship; great ep (other than the Phoebe line I always hated "my eyes! my eyes!"). 
It's also a great example of common knowledge and rational agents in game theory.

One problem with titles: "The One with the Embryos" gives no information other than a noun that is related to babies. `r emo::ji(':(')` No character names and no indication of why I like it.

``` {r}
# The worst episodes
titles %>% arrange(rating) %>% head(5)
```

They're all clip shows lmao. Ratings are accurate then.

## Are the directors any good?

I'm trying to write a good Friends script, who should I get to direct it? Here, we'll just have to `unnest` the list-cols (because of one episode that has two directors, for some reason), and then group and summarize. I've already picked out a few directors to highlight with [`geom_text_repel`](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html). 

``` {r}
# Get a dataset of directors
dirs <- titles %>% 
  unnest(director) %>%
  group_by(director) %>%
  summarize(n = n(), rating = mean(rating))

# A list of interesting people
notable_dirs <-c("Joe Regalbuto", 
                 "Peter Bonerz",
                 "David Schwimmer",
                 "Kevin Bright", 
                 "Gary Halvorson")

# scatterplot of rating vs. number of episodes directed
ggplot(dirs, aes(x = n, y = rating, colour = director %in% notable_dirs)) + 
  geom_point() + 
  geom_text_repel(aes(label = director)) +
  labs(title = "Directors: Avg. rating vs. No. of episodes",
       x = "No. of eps", y = 'Avg. rating') + 
  theme(legend.position = "none") + 
  scale_colour_manual(values=c("black", "#ce0411"))
```

There aren't many that stick out---we'd want Kevin Bright (of Bright/Kaufman/Crane), who has one of the highest average ratings and directed over 50 eps. Gary Halvorson's done a lot, but he's only an average Friends director.

Also Peter Bonerz lolol. On the other hand: David Schwimmer directed like 10 episodes!  I assume he directed all the ones about Ross:

``` {r}
titles %>% 
  unnest(director) %>% 
  filter(director == "David Schwimmer")
```

Nope. I guess he did ok, mainly focusing on Seasons 7 and 8 and coming out with an average rating of `r titles %>% unnest(director) %>% filter(director == "David Schwimmer") %>% pull(rating) %>% mean() %>% round(2)`, slightly higher than the series average of `r mean(titles$rating) %>% round(2)`. Well. Fine. Ross still sucks.

## Title character breakdown

I bet if I write an episode titled "The One Where Rachel [does X]" it'll be an automatic classic. Let's check. First, use `tidytext::unnest_tokens` to split the titles into words, and then take out common filler words ('The', 'One', 'a', etc.) with the quick and helpful `anti_join(stop_words)`.

``` {r}
title_words <- titles %>% 
  select(-director, -writers) %>% 
  unnest_tokens(word, title) %>% 
  anti_join(stop_words)
title_words
```

Now we'll just count the number of times each word occurs in a title, and calculate the average rating for each word:

``` {r}
title_words %>% 
  filter(! word %in% c('1', '2')) %>% 
  mutate(word = gsub("'s", "", word)) %>% # to make "Ross" = "Ross's"
  group_by(word) %>% 
  summarize(n = n(), rating = rating %>% mean() %>% round(2)) %>%
  arrange(-n) %>% head(6)
```

The characters are the most frequent title words, and 'Rachel' (surprise, surprise) is No. 1. But episodes with 'Ross' in the title are actually rated slightly better!

That gives us some info into explaining ratings: some directors are good, with a lot of noise. Some words are popular, but with a lot of noise. And don't write a f-----g clip show. Next up, let's use the titles and statistics to explain ratings!

## Appendix: `rvest`

The toughest part of learning `rvest` is the lack of transparency in the returned objects. I find it difficult to navigate a page with `rvest` through trial-and-error because it's hard to see inside the `xml_document` or `xml_nodeset` objects---but maybe there's some `xml` stuff I don't understand yet. Anyway, here's what I found.

First, explore the IMDB html / source. The Friends url is easy to find, and then we need a way to go from each season's page (that lists the episodes) to each individual episode page (to get the data). Suppose we have the season url and one episode url, let's write a function to get that episode's data.

We need: `html_session` to jump to different links, then read the html with `read_html` (good name). [`selectorgadget`](http://selectorgadget.com/) is a useful chrome extension to find CSS paths that select the objects you like, but I found it easier to just right-click + inspect element and find attributes that identify the things I want (usually `class` and `id`; though `itemprop` turns out to be super useful on these imdb pages).

Here, I'm looking for episode title (inspect element suggests `div h1[itemprop="name"])` would select the title (which I need to verify for this one, and then hope it works for the rest `r emo::ji('pray')`). Also rating (`span[itemprop="ratingValue"]) and rating count (`span[itemprop="ratingCount"]`).

After that, we get lists of directors and writers from the cast table, and filter accordingly. Sometimes the writers are listed with credits "written by", sometimes "writer", or "teleplay by" or "story by" or whatever else they like to say.

Finally, we stick them all in a tibble and return it. The writers and directors are returned in list-cols, so every episode gets one row.

``` {r}
get_ep_data <- function(ep_url, url) {
  # given a show url (for the session), 
  # and an episode url (relative to the show url) 
  # follow the link to the episode and download the episode data
  # print(paste0("S:", stringr::str_extract(url, "(\\d*)$"), 
  #              " E:", stringr::str_extract(ep_url, "(\\d*)$")))
  # print(ep_url)
  
  # start a session and jump to the episode url
  session <- html_session(paste0(url)) %>%  jump_to(ep_url)
  
  # then read the episode page.
  page <- session %>% read_html()
  
  title <- page %>% 
    html_nodes('div h1[itemprop="name"]') %>% 
    html_text() %>% trimws()
  
  rating <- page %>% 
    html_nodes('span[itemprop="ratingValue"]') %>% 
    html_text() %>% as.numeric()
  
  n_ratings <- page %>% 
    html_nodes('span[itemprop="ratingCount"]') %>% 
    html_text() %>% gsub(pattern = ",", replacement = "") %>% as.numeric()
  
  # get writer / director info.
  cast_table <- session %>% follow_link(i = "See full cast & crew") %>%
    html_nodes(".simpleCreditsTable") %>% 
    html_table()
  
  # the director is first in the list of tables.
  director <- cast_table %>% .[[1]] %>% .[,1] 
  
  # nope! sometimes it says "teleplay by" and "story by". use those too.
  # I think the writers are in the second table in the list of tables?
  writers <- cast_table %>% .[[2]] %>% 
    filter(grepl("writer|written|teleplay|story", X3)) %>%  .[,1]
  
  tibble(
    season = stringr::str_extract(url, "(\\d*)$") %>% as.numeric(),
    episode = stringr::str_extract(ep_url, "(\\d*)$") %>% as.numeric(), 
    title = title, 
    rating = rating, 
    n_ratings = n_ratings, 
    director = lst(director), 
    writers = lst(writers)
  )
}
```

Once we have that episode data function, we can write a function to return season data (although you *know* I wrote this first just to download the season url and look for the episode titles). 

First, `read_html` the url. The episode titles can be found (via a quick inspect element) with the tags `strong a[itemprop="name"]`; then ask for the `href`/link attribute via `html_attr`.

This is my first experiment with `purrr::possibly`---since html sessions can do weird stuff (with this very detailed bug report: bad stuff happens sometimes), if getting the episode data fails for some reason, just forget about that episode for now.

``` {r}
get_season_data <- function(url) {
  # given the show url, download episode data for every episode in every season
  
  html <- read_html(url)
  
  # get links to all episodes.
  ep_list <- html %>% 
    html_nodes(css = 'strong a[itemprop="name"]') %>%
    html_attr('href')
  
  # for each episode in the list, safely get the data
  safe_get_ep_data <- possibly(get_ep_data, otherwise = NULL)
  
  # return a dataframe of all episode data
  ep_list %>% map(safe_get_ep_data, url = url) %>% bind_rows() 
}

```

