---
title: "Friends episode titles, pt. 1"
author: "Jesse Tweedle"
date: '2017-12-18'
slug: friends-titles-pt1
categories: ["r"]
tags: ["r", "friends", "imdb", "NLP", "rvest"]
---

```{r setup, include=FALSE}
# set fig_height, fig_width.
knitr::opts_chunk$set(collapse = TRUE)
library(rvest)
library(tidyverse)
library(tidytext)
library(ggplot2)
```

I always wanted to be a scriptwriter. But my approach to doing creative things is "find the secret, program it, retire". So what's the secret to a successful Friends episode? [Really, I want to write/experience a gentle introduction to the following things: `rvest`, `tidytext`, and language data science.]

I'll explore this data science via a workflow like:

  1. Get data via IMDB / `rvest`
  3. Explore---what am I looking for?
  4. Set up a model
  5. Draw conclusions
  6. Next steps


## Get data

I'll get data on Friends episodes from IMDB via `rvest` (see here for [tutorials](https://github.com/hadley/rvest) and [documentation](https://cran.r-project.org/web/packages/rvest/rvest.pdf)).

Start your engines:
``` {r eval = FALSE}
library(rvest)
library(XML) # why? not sure.
library(tidyverse)
library(tidytext)
```

First, find the link, and download some html.

``` {r}
# A generic URL to pull out a single season
url <- "http://www.imdb.com/title/tt0108778/episodes?season="

# Attach season numbers 1:10 to the url, return a chr vector
urls <- map_chr(1:10, function(n) {paste0(url, n)})

# apply read_html to each url in the list
pages <- map(urls, read_html)
```

Pages is now a list of html from each season. We want two things from the data (for now): the title and the rating (a measure of episode success).

Using the [selectorgadget](http://selectorgadget.com/) chrome extension to explore the IMDB CSS, I find I can get titles with the `<strong>` and `<a>` tags, but it returns some unrelated things too.

``` {r}
titles <- pages %>% 
  map(html_nodes, css = 'strong a') %>% 
  map(html_text) %>% 
  enframe() %>% 
  unnest() %>%
  rename(season = name, title = value) %>% 
  filter(grepl("^The One", title)) %>% 
  group_by(season) %>% 
  mutate(episode = row_number()) %>% 
  select(season, episode, title)
titles
```
Filtering titles that start with "The One" actually drop the series finales that actually start with "The Last One". Those were super successful, but that's not really a recipe you can take to a new episode. So I'll forget about them for now.

Next, get the stars by selecting the class `ipl-rating-star__rating` (the leading `.` is a CSS thing for "class"; `#` is for id, and nothing selects a regular tag like `span` or `a`).
``` {r}
stars <- pages %>% 
  map(html_nodes, css = '.ipl-rating-star__rating')%>% 
  map(html_text) %>% 
  enframe() %>%
  unnest() %>% 
  group_by(name) %>% 
  filter(row_number() %in% seq.int(1, max(row_number()), by = 23)) 

stars <- stars %>% 
  mutate(episode = row_number(), value = as.numeric(value)) %>%
  select(season = name, episode, rating = value)
```
The one annoying bit: the `.ipl-rating-star__rating` class also selects the rating widget, so you have to use some ugly logic to filter out the extra html. 

Then join the two datasets together:
``` {r}
titles <- inner_join(titles, stars) # yea, great.
titles
```
Done and done.

## Explore---what am I looking for?

I want to explain ratings from titles. The ratings by season look like:
``` {r}
p <- ggplot(titles, aes(x = factor(season), y = rating, group = season)) + geom_boxplot() + ylim(NA, 10) #+
p #+ title(main = "Friends Ratings By Season", xlab = "Season #", ylab = "Rating")
# }
```

- explain rating from title

## Model

- what explains "successful" titles?

## Conclusions

## Next steps


