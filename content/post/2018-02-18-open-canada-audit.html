---
title: "Open Canada 🇨🇦 Audit with R: C+"
author: "Jesse Tweedle"
date: '2018-02-18'
slug: open-canada-audit
categories: ["r"]
tags: ["r", "open data", "open washing", "api", "rstats", "tidyverse", "data audit"]
description: "Canada's open data portal gets a C+. Get ready for a million tables describing the metadata-only API and the sometimes open data links they provide."
image: "https://jesse.tw/images/circle-arrows.png"
---

<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>


<div id="motivation" class="section level2">
<h2>Motivation</h2>
<p>Open data is an important way to get information in the hands of citizens. Not only for government transparency, but also to make it easier for citizens to access data that has been available for years behind poor user interface design (don’t get me started on CANSIM). Canada has put this into words with <a href="https://open.canada.ca/en/open-data-principles">open data principles</a> and a plan for <a href="https://open.canada.ca/en/content/third-biennial-plan-open-government-partnership">open government partnership</a>; a good first step, otherwise how would I know how to judge them? And more importantly, they’ve followed that up with action: the <a href="https://open.canada.ca/en/open-data">open.canada.ca API</a>.</p>
<p>(<a href="#answers">Skip to the answers.</a>)</p>
<div id="rubric" class="section level3">
<h3>Rubric</h3>
<p>I focus on a <a href="https://open.canada.ca/en/open-data-principles">few open data principles</a> I can evaluate directly (e.g., without subject matter knowledge or checking individual datasets and shapefiles).</p>
<div id="ease-of-physical-and-electronic-access" class="section level4">
<h4>4. Ease of Physical and Electronic Access</h4>
<blockquote>
<p>By contrast, providing an interface for users to make specific calls for data through an Application Programming Interface (API) make data much more readily accessible</p>
</blockquote>
</div>
<div id="machine-readability" class="section level4">
<h4>5. Machine Readability</h4>
<blockquote>
<p>Datasets released by the Government of Canada should be stored in widely-used file formats that easily lend themselves to machine processing (e.g. CSV, XML).</p>
</blockquote>
</div>
<div id="the-fucking-links-should-work-too-obvious-to-be-labelled-a-principle-but-needs-to-be-evaluated-anyway" class="section level4">
<h4>The fucking links should work (too obvious to be labelled a principle but needs to be evaluated anyway)</h4>
<p>This one’s easy—if I click on a link to a dataset, I want it to download the dataset, not get redirected or 404-ed or timeout.</p>
</div>
<div id="true-information-content-also-not-an-official-principle-but-a-way-to-avoid-open-washing" class="section level4">
<h4>True information content (also not an official principle, but a way to avoid open washing)</h4>
<p>We’re bilingual in Canada, so we usually provide every government product in two official languages, English and French. A dataset copied exactly with metadata translated from English to French is good (and required) for citizens, but it’s not really double the amount of information. The same goes for subsetting datasets. As we’ll see later, survey maps of small areas are often posted as individual open datasets—that’s not really 100,000 datasets, it’s really a single dataset of survey maps, right?</p>
<p>That’s like taking a GDP-by-province dataset and splitting into 13 separate datasets and saying it’s 13 times as much information.</p>
</div>
</div>
<div id="strategy" class="section level3">
<h3>Strategy</h3>
<p>Evaluate these four characteristics by:</p>
<ol style="list-style-type: decimal">
<li>check for ease of access of data from the API</li>
<li>check if datasets are available in machine readable and common formats</li>
<li>check if the links actually work</li>
<li>check (broadly) for unique content</li>
</ol>
<p>For me, for now, the rubric is mainly based on dataset availability, but a true audit will need to check and re-check the milestones listed under <a href="https://open.canada.ca/en/content/third-biennial-plan-open-government-partnership#toc5-1-3" class="uri">https://open.canada.ca/en/content/third-biennial-plan-open-government-partnership#toc5-1-3</a>)
the open government plan, e.g.:</p>
<blockquote>
<p>Set a baseline for the total volume of open data to be released over time and establish departmental targets for the publication of releasable data over the next five years</p>
</blockquote>
</div>
</div>
<div id="accessing-the-api" class="section level2">
<h2>Accessing the API</h2>
<p>My first idea was to write an R wrapper for the Canada’s open data API, like <a href="https://twitter.com/kyle_e_walker">Kyle Walker’s</a> <a href="https://github.com/walkerke/tidycensus">tidycensus</a> R package for the US census—so useful.</p>
<p>Wrong—unless I’m super dumb, the API gives you metadata only. The docs give example code for accessing one that returns data, but <a href="https://open.canada.ca/en/working-data#toc93">the example they give</a> (<a href="http://www.earthquakescanada.nrcan.gc.ca/api/earthquakes" class="uri">http://www.earthquakescanada.nrcan.gc.ca/api/earthquakes</a>) isn’t for an NRCAN API, not this one, which is confusing</p>
<p>So I can’t get data directly from the API. (Although I think there might be a wrapper for <a href="https://censusmapper.ca/api">https://censusmapper.ca/api</a>.) I have to search the API for a certain package, and then follow the link to a new site and try to download it from there. How do I know if there are consistent rate limits or scraping prohibitions on any of these datasets if they link to different websites? Whose responsbility is it to fix broken links, outdated documentation, or incorrect metadata? Who knows.</p>
<p>So Principle 4 <em>Ease of Physical and Electronic Access</em> is out. The API doesn’t access data. Although I’ll stipulate that one can access a link that can access data to evaluate the other principles.</p>
<p>The <a href="https://open.canada.ca/en/working-data">docs don’t give R examples</a> anyway, but it’s a <a href="https://ckan.org/">CKAN API</a>, and <a href="https://ropensci.org/">rOpenSci</a> wrote an R package called <a href="https://github.com/ropensci/ckanr">ckanr</a> that makes it a bit easier to access, although I think it was meant for APIs with keys, because I can’t set a <code>user-agent</code> as Hadley Wickham suggests in the <code>httr</code> vignette <a href="https://cran.r-project.org/web/packages/httr/vignettes/api-packages.html">Best practices for API packages</a>. Oh well.</p>
<p>I’ll load the package, set it up with the link I want, and search through and save the packages. I use a loop because the search only returns 1000 packages at once, but you can specify where to start and stop the search. So I search until I can’t get any more. With a <code>Sys.sleep</code> for 10 seconds just in case; I have no idea if there’s a rate limit for these.</p>
<pre class="r"><code>library(ckanr) # package to access CKAN APIs

ckanr_setup(url = &quot;http://open.canada.ca/data/en/&quot;)

api_result &lt;- c()
# returns 1000 packages
# so start at the first,
# get 1000 until you can&#39;t get any more
i &lt;- 1
step &lt;- 1000

while (TRUE) {
  temp_search &lt;- package_search(q = &#39;*:*&#39;, rows = step, start = i)$results
  print(paste0(i, &quot; &quot;, length(temp_search)))
  if (length(temp_search) == 0) break
  api_result &lt;- c(api_result, temp_search)
  i &lt;- i + step
  Sys.sleep(10) # no idea about rate limits for this, 
                # so just sleep for 10 seconds
                # before going again
}</code></pre>
<p>Now <code>api_result</code> has a list of package metadata, including all the links to possible datasets. One package may have several links for one dataset in different formats and languages, as well as documentation links. So pull out the package <code>id</code> and <code>resources</code> that contain all the information I want; I’ll also want a bit more information on the organization that published the data. I use <code>purrr</code> liberally to try to simplify the process of converting a list of lists of lists to a <code>tibble</code> we’re more comfortable with.</p>
<pre class="r"><code>api_resources &lt;- api_result %&gt;%
  map(`[`, c(&quot;id&quot;, &quot;resources&quot;)) %&gt;%
  map(enframe) %&gt;%
  map(~ spread(.x, key = &quot;name&quot;, value = &quot;value&quot;)) %&gt;%
  map(~ mutate(.x, id = map_chr(id, ~.x))) %&gt;% bind_rows()

api_resources_unnest &lt;- api_resources %&gt;%
  mutate(resource_urls = map(resources, map_chr, ~.x[[&quot;url&quot;]]),
         resource_type = map(resources, map_chr, ~.x[[&quot;resource_type&quot;]])) %&gt;%
  unnest(resource_urls, resource_type)

# also metadata, including organization that published the data.
api_metadata &lt;- api_result %&gt;%
  map(`[`, c(&quot;id&quot;, &quot;org_title_at_publication&quot;, &quot;spatial&quot;)) %&gt;% map_df(. %&gt;% unlist() %&gt;% t() %&gt;% as_tibble()) %&gt;%
  mutate(spatial = is.na(spatial) | spatial != &quot;&quot;)

# and merge those together.
api_resources &lt;- api_resources_unnest %&gt;%
  left_join(api_metadata, by = c(&quot;id&quot;)) # merge on metadata

# save and compress the data for you to check
write_csv(api_resources, &quot;api_resources.csv&quot;)
zip(&quot;api_resources.zip&quot;, &quot;api_resources.csv&quot;)</code></pre>
</div>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Let’s check basic characteristics of the datasets.</p>
<div id="resource-type-breakdown" class="section level3">
<h3>Resource type breakdown</h3>
<pre class="r"><code># later, eval = TRUE, but fix tables first.
api_resources &lt;- read_csv(&quot;api_resources.zip&quot;)

api_resources %&gt;%
  count(resource_type, sort = TRUE) %&gt;%
  mutate(Freq = scales::percent(n / sum(n))) %&gt;%
  slice(1:10) %&gt;%
  rename(`Resource type` = resource_type, Count = n) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;lrr&quot;, caption = &quot;Breakdown of resource types&quot;) %&gt;% 
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-3">Table 1: </span>Breakdown of resource types
</caption>
<thead>
<tr>
<th style="text-align:left;">
Resource type
</th>
<th style="text-align:right;">
Count
</th>
<th style="text-align:right;">
Freq
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
dataset
</td>
<td style="text-align:right;">
154990
</td>
<td style="text-align:right;">
87.7%
</td>
</tr>
<tr>
<td style="text-align:left;">
guide
</td>
<td style="text-align:right;">
14907
</td>
<td style="text-align:right;">
8.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
web_service
</td>
<td style="text-align:right;">
2467
</td>
<td style="text-align:right;">
1.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
policy
</td>
<td style="text-align:right;">
1193
</td>
<td style="text-align:right;">
0.7%
</td>
</tr>
<tr>
<td style="text-align:left;">
article
</td>
<td style="text-align:right;">
485
</td>
<td style="text-align:right;">
0.3%
</td>
</tr>
<tr>
<td style="text-align:left;">
website
</td>
<td style="text-align:right;">
400
</td>
<td style="text-align:right;">
0.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
publication
</td>
<td style="text-align:right;">
387
</td>
<td style="text-align:right;">
0.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
audit
</td>
<td style="text-align:right;">
350
</td>
<td style="text-align:right;">
0.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
application
</td>
<td style="text-align:right;">
295
</td>
<td style="text-align:right;">
0.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
strategic_plan
</td>
<td style="text-align:right;">
220
</td>
<td style="text-align:right;">
0.1%
</td>
</tr>
</tbody>
</table>
<p>About 150,000 (which means about 75000 or less, since half of them are probably translations). Shouldn’t there be way more documentation? Like one for each dataset? Like 75000-ish pieces of documentation?</p>
</div>
<div id="organization-breakdown" class="section level3">
<h3>Organization breakdown</h3>
<pre class="r"><code>api_datasets &lt;- api_resources %&gt;% filter(resource_type == &quot;dataset&quot;)

api_datasets %&gt;%
  count(org_title_at_publication.en, org_title_at_publication.fr, sort = TRUE) %&gt;%
  slice(1:10) %&gt;%
  mutate(Freq = scales::percent(n / sum(n))) %&gt;%
  rename(`Organization (English)` = org_title_at_publication.en,
         `Organization (French)` = org_title_at_publication.fr,
         Count = n) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;llrr&quot;, caption = &quot;Organization breakdown&quot;) %&gt;%
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-4">Table 2: </span>Organization breakdown
</caption>
<thead>
<tr>
<th style="text-align:left;">
Organization (English)
</th>
<th style="text-align:left;">
Organization (French)
</th>
<th style="text-align:right;">
Count
</th>
<th style="text-align:right;">
Freq
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Natural Resources Canada
</td>
<td style="text-align:left;">
Ressources naturelles Canada
</td>
<td style="text-align:right;">
126092
</td>
<td style="text-align:right;">
83.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
Statistics Canada
</td>
<td style="text-align:left;">
Statistique Canada
</td>
<td style="text-align:right;">
19137
</td>
<td style="text-align:right;">
12.6%
</td>
</tr>
<tr>
<td style="text-align:left;">
Environment and Climate Change Canada
</td>
<td style="text-align:left;">
Environnement et Changement climatique Canada
</td>
<td style="text-align:right;">
2064
</td>
<td style="text-align:right;">
1.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
Canada Revenue Agency
</td>
<td style="text-align:left;">
Agence du revenu du Canada
</td>
<td style="text-align:right;">
1194
</td>
<td style="text-align:right;">
0.8%
</td>
</tr>
<tr>
<td style="text-align:left;">
Veterans Affairs Canada
</td>
<td style="text-align:left;">
Anciens Combattants Canada
</td>
<td style="text-align:right;">
654
</td>
<td style="text-align:right;">
0.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
Public Works and Government Services Canada
</td>
<td style="text-align:left;">
Travaux publics et Services gouvernementaux Canada
</td>
<td style="text-align:right;">
538
</td>
<td style="text-align:right;">
0.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
Agriculture and Agri-Food Canada
</td>
<td style="text-align:left;">
Agriculture et Agroalimentaire Canada
</td>
<td style="text-align:right;">
522
</td>
<td style="text-align:right;">
0.3%
</td>
</tr>
<tr>
<td style="text-align:left;">
Treasury Board of Canada Secretariat
</td>
<td style="text-align:left;">
Secrétariat du Conseil du Trésor du Canada
</td>
<td style="text-align:right;">
514
</td>
<td style="text-align:right;">
0.3%
</td>
</tr>
<tr>
<td style="text-align:left;">
Employment and Social Development Canada
</td>
<td style="text-align:left;">
Emploi et Développement social Canada
</td>
<td style="text-align:right;">
497
</td>
<td style="text-align:right;">
0.3%
</td>
</tr>
<tr>
<td style="text-align:left;">
Department of Finance Canada
</td>
<td style="text-align:left;">
Ministère des Finances Canada
</td>
<td style="text-align:right;">
412
</td>
<td style="text-align:right;">
0.3%
</td>
</tr>
</tbody>
</table>
<p>NRCAN/RNCAN is producing most of them. Which means they’re probably just individual maps, which is not great for the ‘unique information content’ principle. Are 100,000 individual maps of different areas in Canada different than one big map of Canada? idk.</p>
<pre class="r"><code>api_datasets %&gt;%
  count(org_title_at_publication.en, org_title_at_publication.fr) %&gt;%
  filter(is.na(org_title_at_publication.en) | is.na(org_title_at_publication.fr))
## # A tibble: 4 x 3
##   org_title_at_publication.en   org_title_at_publication.fr               n
##   &lt;chr&gt;                         &lt;chr&gt;                                 &lt;int&gt;
## 1 Environment and Climate Chan… &lt;NA&gt;                                      3
## 2 National Energy Board         &lt;NA&gt;                                    178
## 3 &lt;NA&gt;                          Commission des libérations condition…    92
## 4 &lt;NA&gt;                          Conseil des arts du Canada                1</code></pre>
<p>Whoops, I guess a few of the organization titles were also a bit messed up.</p>
</div>
</div>
<div id="investigate-urls" class="section level2">
<h2>Investigate URLs</h2>
<p>This is the crux of the argument. I check machine readability and link health.</p>
<div id="schemeshttp-vs-https-vs-ftp-etc." class="section level3">
<h3>Schemes—http vs https vs ftp, etc.</h3>
<pre class="r"><code>api_datasets %&gt;%
  mutate(scheme = tolower(scheme)) %&gt;%
  count(scheme) %&gt;%
  mutate(Freq = scales::percent(n / sum(n))) %&gt;%
  rename(Scheme = scheme, Count = n) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;lrr&quot;, caption = &quot;Breakdown of schemes---mostly insecure&quot;) %&gt;% 
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-6">Table 3: </span>Breakdown of schemes—mostly insecure
</caption>
<thead>
<tr>
<th style="text-align:left;">
Scheme
</th>
<th style="text-align:right;">
Count
</th>
<th style="text-align:right;">
Freq
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
file
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.0%
</td>
</tr>
<tr>
<td style="text-align:left;">
ftp
</td>
<td style="text-align:right;">
6546
</td>
<td style="text-align:right;">
4.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
http
</td>
<td style="text-align:right;">
147484
</td>
<td style="text-align:right;">
95.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
https
</td>
<td style="text-align:right;">
957
</td>
<td style="text-align:right;">
0.6%
</td>
</tr>
<tr>
<td style="text-align:left;">
ttps
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.0%
</td>
</tr>
</tbody>
</table>
<p>Ugh. About 99% are on http/ftp protocols, which apparently are going to be <a href="https://www.theverge.com/2018/2/8/16991254/chrome-not-secure-marked-http-encryption-ssl">marked <code>insecure</code> by chrome</a> in a couple of months (July 2018).</p>
</div>
<div id="weird-and-wrong-urls" class="section level3">
<h3>Weird and wrong URLs</h3>
<pre class="r"><code>api_datasets %&gt;%
  select(hostname) %&gt;%
  filter(!grepl(&quot;(ca|fr|gov|net|com|org)$&quot;, x = hostname))
## # A tibble: 9 x 1
##   hostname                                                                 
##   &lt;chr&gt;                                                                    
## 1 Water-Qual-Eau-S-Saskatchewan-2000-present.csv                           
## 2 Water-Qual-Eau-Yukon-2000-present.csv                                    
## 3 2014_ACC_RapportstatistiqueLAI_Tableau2.5.2_Pagespertinentestraitéesetdi…
## 4 2013-2014_VAC_ATIStatisticalReport_AppendixA_Table1_Numberofinformalrele…
## 5 2013-2014_VAC_ATIStatisticalReport_AppendixA_Table2_RequestswithLegalSer…
## 6 2013-2014_VAC_ATIStatisticalReport_AppendixA_Table2_RequestswithLegalSer…
## 7 8ed50921-bb46-404d-92fc-69b74a827238                                     
## 8 205.193.86.89                                                            
## 9 2015-07-01 -- 2015-07-04 Marine-marin.csv</code></pre>
<p>Well, those are just wrong (except one is just an IP address, which is strange but it works). Also there are some non-Canadian hosts for some reason (I needed to filter hostnames for <code>.fr</code>, <code>.gov</code>, <code>.net</code>, etc.).</p>
</div>
<div id="file-types" class="section level3">
<h3>File types</h3>
<pre class="r"><code>file_types &lt;- api_datasets %&gt;%
  mutate(type = path %&gt;%
           str_match(&quot;\\.[A-Za-z]{3,4}$&quot;) %&gt;%
           gsub(&quot;\\.&quot;, &quot;&quot;, x = .) %&gt;% tolower())

file_types %&gt;%
  count(type, sort = TRUE) %&gt;%
  slice(1:10) %&gt;%
  mutate(Freq = scales::percent(n / sum(n))) %&gt;%
  rename(Filetype = type, Count = n) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;lrr&quot;, caption = &quot;Breakdown of file types listed in the API&quot;) %&gt;% 
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-8">Table 4: </span>Breakdown of file types listed in the API
</caption>
<thead>
<tr>
<th style="text-align:left;">
Filetype
</th>
<th style="text-align:right;">
Count
</th>
<th style="text-align:right;">
Freq
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
php
</td>
<td style="text-align:right;">
103526
</td>
<td style="text-align:right;">
68.7%
</td>
</tr>
<tr>
<td style="text-align:left;">
zip
</td>
<td style="text-align:right;">
26104
</td>
<td style="text-align:right;">
17.3%
</td>
</tr>
<tr>
<td style="text-align:left;">
csv
</td>
<td style="text-align:right;">
5245
</td>
<td style="text-align:right;">
3.5%
</td>
</tr>
<tr>
<td style="text-align:left;">
NA
</td>
<td style="text-align:right;">
4784
</td>
<td style="text-align:right;">
3.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
pdf
</td>
<td style="text-align:right;">
2915
</td>
<td style="text-align:right;">
1.9%
</td>
</tr>
<tr>
<td style="text-align:left;">
txt
</td>
<td style="text-align:right;">
2562
</td>
<td style="text-align:right;">
1.7%
</td>
</tr>
<tr>
<td style="text-align:left;">
sgy
</td>
<td style="text-align:right;">
1618
</td>
<td style="text-align:right;">
1.1%
</td>
</tr>
<tr>
<td style="text-align:left;">
edi
</td>
<td style="text-align:right;">
1580
</td>
<td style="text-align:right;">
1.0%
</td>
</tr>
<tr>
<td style="text-align:left;">
xls
</td>
<td style="text-align:right;">
1222
</td>
<td style="text-align:right;">
0.8%
</td>
</tr>
<tr>
<td style="text-align:left;">
cgi
</td>
<td style="text-align:right;">
1134
</td>
<td style="text-align:right;">
0.8%
</td>
</tr>
</tbody>
</table>
<p>So many php and <code>NA</code>s, that’s not good. <code>NA</code> means the file path regular expression didn’t pick up a file type, so it’s probably not a file. php isn’t a machine readable dataset, it’s usually just used to make HTML. Aka it’s just a webpage that may or may not give you easy access to data (check one example here: <a href="http://gdr.agg.nrcan.gc.ca/gdrdap/dap/index-eng.php?data_file_name=Sylvan+lignite+channel.gdb" class="uri">http://gdr.agg.nrcan.gc.ca/gdrdap/dap/index-eng.php?data_file_name=Sylvan+lignite+channel.gdb</a>).</p>
<p>There are a decent number of zips (ok, but no way to tell what’s in it), csvs (good, usually), pdfs (no no no no no). And a million others I’ve never heard of, so I have no idea whether they’re really useful and machine readable datasets or not. I won’t say they’re not useful only bc I don’t know them; they might just be a bunch of very idiosyncratic formats for things that are very useful
to small subsets of people. So I’ll leave that (dot dot dot) for now.</p>
</div>
</div>
<div id="test-urls" class="section level2">
<h2>Test URLs</h2>
<p>Next, test the URLs! First, filter the non-dataset survey maps (which all have the hostnames <code>clss.nrcan.gc.ca</code> or <code>satc.rncan.gc.ca</code>). Use strat I outlined in my previous post <a href="/post/testing-urls/">Measuring URL health in R</a>.</p>
<pre class="r"><code>head_timeout &lt;- function(url) {
  Sys.sleep(0.25)
  HEAD(url, timeout(5))
}
quietly_safely_head &lt;- quietly(safely(head_timeout))

api_test_urls &lt;- api_datasets %&gt;%
  filter(!hostname %in% c(&quot;clss.nrcan.gc.ca&quot;, &quot;satc.rncan.gc.ca&quot;)) %&gt;%
  mutate(test = map(resource_urls, list))

# loop, bc I don&#39;t want to lose it if I lose internet access or something.
for (i in seq_len(nrow(api_test_urls))) {
  print(paste0(i, &quot;: &quot;, api_test_urls[i, ]$resource_urls))
  api_test_urls[i, ]$api_test_urls &lt;- list(quietly_safely_head(api_test_urls[i, ]$resource_urls))
}</code></pre>
<p>We’ve sent a HEAD request to every dataset listed in the API. Now let’s process the results and see what they say.</p>
<pre class="r"><code># func to process url test results.
process_test &lt;- function(test) {
  result &lt;- test$result$result
  error &lt;- test$result$error$message

  warnings &lt;- test$warnings

  if (!is.null(warnings) &amp;&amp; length(warnings) &gt; 0) {
    warnings &lt;- warnings[[length(warnings)]]
  } else {
    warnings &lt;- &quot;&quot;
  }

  head_url &lt;- result$url
  status_code &lt;- result$status_code
  # status codes are different for FTP, see:
  # https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes

  list(error = error,
       warnings = warnings,
       head_url = head_url,
       status_code = status_code) %&gt;%
    t() %&gt;% as_tibble()
}

api_test_results &lt;- api_test_urls %&gt;%
  mutate(res = map(test, process_test)) %&gt;%
  unnest(res) %&gt;%
  mutate_at(c(&quot;error&quot;, &quot;head_url&quot;, &quot;status_code&quot;, &quot;warnings&quot;), as.character) %&gt;%
  mutate_at(c(&quot;error&quot;, &quot;head_url&quot;, &quot;status_code&quot;, &quot;warnings&quot;), ~ ifelse(. %in% c(&quot;NULL&quot;, &quot;&quot;), NA, .)) %&gt;%
  mutate(redirect = head_url != resource_urls) %&gt;%
  select(resource_urls, error, warnings, head_url, status_code, redirect) %&gt;%
  mutate(error_type = case_when(
    is.na(error) ~ &quot;None&quot;,
    grepl(&quot;Could not resolve host&quot;, x = error) ~ &quot;Could not resolve host&quot;,
    grepl(&quot;Timeout was reached&quot;, x = error) ~ &quot;Timeout&quot;,
    TRUE ~ &quot;Other&quot;
  ))</code></pre>
<p>^^ We’ve saved errors, warnings, status codes, and redirected URLs. Let’s go.</p>
<div id="count-errors-warnings-redirects-and-status-codes" class="section level3">
<h3>Count errors, warnings, redirects, and status codes</h3>
<p>First, count the number and types of errors:</p>
<pre class="r"><code>api_test_results &lt;- read_csv(&quot;api_test_results.zip&quot;)

api_test_results %&gt;%
  count(error_type, sort = TRUE) %&gt;%
  mutate(Freq = scales::percent(n / sum(n))) %&gt;%
  rename(`Error type` = error_type, Count = n) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;lrr&quot;, caption = &quot;Breakdown of url errors&quot;) %&gt;%
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-11">Table 5: </span>Breakdown of url errors
</caption>
<thead>
<tr>
<th style="text-align:left;">
Error type
</th>
<th style="text-align:right;">
Count
</th>
<th style="text-align:right;">
Freq
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
None
</td>
<td style="text-align:right;">
52102
</td>
<td style="text-align:right;">
93.7%
</td>
</tr>
<tr>
<td style="text-align:left;">
Timeout
</td>
<td style="text-align:right;">
3432
</td>
<td style="text-align:right;">
6.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
Other
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
0.1%
</td>
</tr>
<tr>
<td style="text-align:left;">
Could not resolve host
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
0.0%
</td>
</tr>
</tbody>
</table>
<p>93.7% don’t have errors, but 6.2% timeout (they’re all from <a href="http://acdi-cida.gc.ca">acdi-cida.gc.ca</a>, which just doesn’t work). Come on. 6% of the datasets don’t work! And if you don’t set a timeout on your HEAD request, your R session hangs! 😡❗.</p>
<pre class="r"><code>## status codes:
# https://en.wikipedia.org/wiki/List_of_HTTP_status_codes
# https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes

api_test_results %&gt;%
  left_join(api_datasets %&gt;%
              mutate(scheme = tolower(scheme)) %&gt;%
              distinct(resource_urls, scheme), by = &quot;resource_urls&quot;) %&gt;%
  count(status_code, scheme) %&gt;%
  filter(!scheme %in% c(&quot;file&quot;, &quot;ttps&quot;)) %&gt;%
  group_by(scheme) %&gt;%
  mutate(freq = scales::percent(n / sum(n))) %&gt;% # need to group by FTP as well.
  select(-n) %&gt;%
  spread(key = scheme, value = freq) %&gt;%
  rename(`Status code` = status_code) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;crrr&quot;, caption = &quot;URL status codes by scheme&quot;) %&gt;%
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-12">Table 6: </span>URL status codes by scheme
</caption>
<thead>
<tr>
<th style="text-align:center;">
Status code
</th>
<th style="text-align:right;">
ftp
</th>
<th style="text-align:right;">
http
</th>
<th style="text-align:right;">
https
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
200
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
88.4%
</td>
<td style="text-align:right;">
81.0%
</td>
</tr>
<tr>
<td style="text-align:center;">
202
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.0%
</td>
<td style="text-align:right;">
0.2%
</td>
</tr>
<tr>
<td style="text-align:center;">
221
</td>
<td style="text-align:right;">
0.0%
</td>
<td style="text-align:right;">
1.3%
</td>
<td style="text-align:right;">
5.9%
</td>
</tr>
<tr>
<td style="text-align:center;">
250
</td>
<td style="text-align:right;">
0.5%
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:center;">
300
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1.1%
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:center;">
350
</td>
<td style="text-align:right;">
98.5%
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:center;">
400
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.1%
</td>
<td style="text-align:right;">
7.0%
</td>
</tr>
<tr>
<td style="text-align:center;">
403
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.0%
</td>
<td style="text-align:right;">
0.1%
</td>
</tr>
<tr>
<td style="text-align:center;">
404
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1.7%
</td>
<td style="text-align:right;">
0.5%
</td>
</tr>
<tr>
<td style="text-align:center;">
405
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.2%
</td>
<td style="text-align:right;">
2.3%
</td>
</tr>
<tr>
<td style="text-align:center;">
500
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.0%
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:center;">
502
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.1%
</td>
</tr>
<tr>
<td style="text-align:center;">
505
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.0%
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:center;">
NA
</td>
<td style="text-align:right;">
1.1%
</td>
<td style="text-align:right;">
7.1%
</td>
<td style="text-align:right;">
2.9%
</td>
</tr>
</tbody>
</table>
<p>Ok, 88% of the http requests, 81% of the https requests, and 98.5% of the ftp requests return ok. (<a href="https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes">ftp status codes</a> and <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">http status codes</a> have different specs). <code>NA</code> status codes means I never got to the status because the request didn’t even work—these are the timeout and <strong>could not resolve host</strong> errors from before.</p>
<pre class="r"><code># lol. those aren&#39;t great. redirects that are really 404s
api_test_results %&gt;%
  filter(status_code == &quot;300&quot;) %&gt;%
  distinct(resource_urls, head_url) %&gt;% glimpse()
## Observations: 1
## Variables: 2
## $ resource_urls &lt;chr&gt; &quot;http://www20.statcan.gc.ca/tables-tableaux/cansim…
## $ head_url      &lt;chr&gt; &quot;http://www20.statcan.gc.ca/tables-tableaux/cansim…</code></pre>
<p>Dang, the 300 status returns are really <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#3xx_Redirection">just redirects to a 404</a>, so I’m counting them as 404s later. Don’t give me that.</p>
<pre class="r"><code># Clean data to make result tables
api_test_results_table &lt;- api_test_results %&gt;%
  mutate(warnings = !is.na(warnings)) %&gt;%
  mutate(status_code = case_when(
    status_code == &quot;300&quot; ~ &quot;4xx&quot;,
    substr(status_code, 1, 1) == &quot;2&quot; | status_code == &quot;350&quot; ~ &quot;2xx&quot;, # includes 350 FTP status.
    substr(status_code, 1, 1) == &quot;4&quot; ~ &quot;4xx&quot;,
    substr(status_code, 1, 1) == &quot;5&quot; ~ &quot;5xx&quot;,
    TRUE ~ &quot;xxx&quot;
  )) %&gt;%
  count(status_code, error_type = error_type != &quot;None&quot;, redirect, warnings)</code></pre>
<!-- -->
<pre class="r"><code>api_test_results_table %&gt;% 
  mutate(freq = scales::percent(n / sum(n))) %&gt;%
  select(-n) %&gt;%
  filter(error_type == FALSE) %&gt;% select(-error_type) %&gt;%
  spread(key = status_code, value = freq, fill = &quot;0%&quot;) %&gt;%
  rename(Redirect = redirect, Warning = warnings) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;ccrrr&quot;, caption = &quot;Breakdown of URL status (freq.)&quot;) %&gt;%
  kableExtra::kable_styling(full_width = FALSE) %&gt;%
  kableExtra::add_header_above(c(&quot; &quot; = 2, &quot;Status code&quot; = 3))</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-15">Table 7: </span>Breakdown of URL status (freq.)
</caption>
<thead>
<tr>
<th style="border-bottom:hidden" colspan="2">
</th>
<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Status code
</div>
</th>
</tr>
<tr>
<th style="text-align:center;">
Redirect
</th>
<th style="text-align:center;">
Warning
</th>
<th style="text-align:right;">
2xx
</th>
<th style="text-align:right;">
4xx
</th>
<th style="text-align:right;">
5xx
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:right;">
72.7%
</td>
<td style="text-align:right;">
2.8%
</td>
<td style="text-align:right;">
0.0%
</td>
</tr>
<tr>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:right;">
12.7%
</td>
<td style="text-align:right;">
0%
</td>
<td style="text-align:right;">
0%
</td>
</tr>
<tr>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:right;">
4.9%
</td>
<td style="text-align:right;">
0.2%
</td>
<td style="text-align:right;">
0%
</td>
</tr>
<tr>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:right;">
0.4%
</td>
<td style="text-align:right;">
0.0%
</td>
<td style="text-align:right;">
0%
</td>
</tr>
</tbody>
</table>
<p>Here, I’ve made a frequency table (above) and a count table (below) of the errors, warnings and status codes of all the datasets.</p>
<pre class="r"><code>api_test_results_table %&gt;%
  filter(error_type == FALSE) %&gt;% select(-error_type) %&gt;%
  spread(key = status_code, value = n, fill = &quot;0&quot;) %&gt;%
  rename(Redirect = redirect, Warning = warnings) %&gt;%
  knitr::kable(&quot;html&quot;, align = &quot;ccrrr&quot;, caption = &quot;Breakdown of URL status (counts)&quot;) %&gt;%
  kableExtra::kable_styling(full_width = FALSE) %&gt;%
  kableExtra::add_header_above(c(&quot; &quot; = 2, &quot;Status code&quot; = 3))</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-16">Table 8: </span>Breakdown of URL status (counts)
</caption>
<thead>
<tr>
<th style="border-bottom:hidden" colspan="2">
</th>
<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Status code
</div>
</th>
</tr>
<tr>
<th style="text-align:center;">
Redirect
</th>
<th style="text-align:center;">
Warning
</th>
<th style="text-align:right;">
2xx
</th>
<th style="text-align:right;">
4xx
</th>
<th style="text-align:right;">
5xx
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:right;">
40437
</td>
<td style="text-align:right;">
1537
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:right;">
7053
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:center;">
FALSE
</td>
<td style="text-align:right;">
2715
</td>
<td style="text-align:right;">
105
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:center;">
TRUE
</td>
<td style="text-align:right;">
245
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>I think 40000 (about 72%) datasets look good, without errors or warnings. About 1500 return 404s, and about 3000 are redirected (with or without warnings) from their original links.</p>
</div>
<div id="answers" class="section level3">
<h3>Back to the rubric</h3>
<div id="ease-of-physical-and-electronic-access-1" class="section level4">
<h4>4. Ease of Physical and Electronic Access</h4>
<p>The API doesn’t access data directly, making you link to other websites to access data, without any idea of whether it’s ok to scrape, different rate limits, different specifications, or even whether the hosts work (which they don’t, in some cases; see, e.g., <a href="http://www.acdi-cida.gc.ca/acdi-cida/ACDI-CIDA.nsf/eng/CAR-616141241-PD4">ACDI-CIDA datasets</a>, because I guess CIDA was folded into Foreign Affairs, but nobody told the dataset links!).</p>
<p>C+. Only because the <code>ckanr</code> package made it pretty easy to access the API without having to understand the docs on the Open Canada page.</p>
</div>
<div id="machine-readability-1" class="section level4">
<h4>5. Machine Readability</h4>
<p>So many phps, pdfs, and no files. B-.</p>
</div>
<div id="the-fucking-links-should-work" class="section level4">
<h4>The fucking links should work</h4>
<p>Only 72% of the actual dataset links work without errors, warnings or redirects. That’s a B or a C+, by itself.</p>
</div>
<div id="true-information-content" class="section level4">
<h4>True information content</h4>
<p>Well, so many maps and doubling the number of datasets because of French/English translations doesn’t really increase the open information content. But that’s fine, as long as you don’t cite each one individually as open. Because we need to provide separate English and French datasets. Grade: B.</p>
</div>
</div>
</div>
<div id="conclusion-open-canada-grade" class="section level2">
<h2>Conclusion: Open Canada Grade</h2>
<p>Overall, I give 🇨🇦 a C+. Which is not a failure. It’s a process that I hope we can work on, especially consolidating the data access into the API directly, instead of relying on outdated links to sites that don’t exist. But the coordination required across these 100s of government departments is difficult enough to manage the metadata already.</p>
<p>Of course one could improve the grade by just deleting all the datasets with problems. That’s why a real audit is important, to make sure Canada’s open data is covering everything it needs to cover; here, I check that what’s there works, but I don’t check anything that should be there that’s not.</p>
<p>To see the data for yourself, either run this code or check the github links to <a href="api_resources.zip">https://github.com/tweed1e/weblog/tree/master/content/post/api_resources.zip</a> and <a href="api_test_results.zip">https://github.com/tweed1e/weblog/tree/master/content/post/api_test_results.zip</a>.</p>
</div>
<div id="endnotes-next-steps" class="section level2">
<h2>Endnotes, next steps</h2>
<p>And this is before I even get to the datasets themselves! CANSIM is famous (to me) for not having consistent industry and geographic classifications. For instance, one dataset will list industries as “Manufacturing [31-33]”, and another “Man.”, and yet another will only have numbers “31-33”. Let alone the province name vs. number problems (“NFLD” vs. “Newfoundland” vs. “Newfoundland and Labrador” vs. “10”). That’s a project for another time.</p>
</div>
